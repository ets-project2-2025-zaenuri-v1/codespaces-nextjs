-- Views and Sample Data for Pempek POS System

-- Create views for reporting
CREATE VIEW v_sales_daily AS
SELECT 
  DATE(o.created_at) as date,
  o.organization_id,
  o.outlet_id,
  COUNT(*) as total_orders,
  SUM(o.total) as total_sales,
  SUM(o.subtotal) as subtotal,
  SUM(o.tax) as total_tax,
  SUM(o.service_charge) as total_service_charge,
  SUM(o.discount) as total_discount,
  AVG(o.total) as avg_order_value
FROM orders o
WHERE o.payment_status = 'paid'
GROUP BY DATE(o.created_at), o.organization_id, o.outlet_id
ORDER BY date DESC;

CREATE VIEW v_top_items AS
SELECT 
  p.name as product_name,
  p.id as product_id,
  COUNT(*) as total_orders,
  SUM(oi.quantity) as total_quantity,
  SUM(oi.total) as total_revenue,
  o.organization_id
FROM order_items oi
JOIN orders o ON oi.order_id = o.id
JOIN products p ON oi.product_id = p.id
WHERE o.payment_status = 'paid'
GROUP BY p.id, p.name, o.organization_id
ORDER BY total_quantity DESC;

CREATE VIEW v_stock_critical AS
SELECT 
  i.name as ingredient_name,
  i.id as ingredient_id,
  i.current_stock,
  i.min_stock,
  i.unit,
  (i.current_stock - i.min_stock) as stock_difference,
  i.organization_id
FROM ingredients i
WHERE i.current_stock <= i.min_stock AND i.is_active = true
ORDER BY stock_difference ASC;

-- Enable Row Level Security (RLS)
ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;
ALTER TABLE outlets ENABLE ROW LEVEL SECURITY;
ALTER TABLE org_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE product_variants ENABLE ROW LEVEL SECURITY;
ALTER TABLE addons ENABLE ROW LEVEL SECURITY;
ALTER TABLE product_addons ENABLE ROW LEVEL SECURITY;
ALTER TABLE media_assets ENABLE ROW LEVEL SECURITY;
ALTER TABLE dining_tables ENABLE ROW LEVEL SECURITY;
ALTER TABLE qr_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE ingredients ENABLE ROW LEVEL SECURITY;
ALTER TABLE recipes ENABLE ROW LEVEL SECURITY;
ALTER TABLE recipe_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE order_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE order_item_addons ENABLE ROW LEVEL SECURITY;
ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE stock_movements ENABLE ROW LEVEL SECURITY;
ALTER TABLE wastage ENABLE ROW LEVEL SECURITY;
ALTER TABLE stock_take ENABLE ROW LEVEL SECURITY;
ALTER TABLE suppliers ENABLE ROW LEVEL SECURITY;
ALTER TABLE purchase_orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE purchase_order_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE goods_receipts ENABLE ROW LEVEL SECURITY;
ALTER TABLE goods_receipt_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE kds_tickets ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;

-- Insert sample organization for testing
INSERT INTO organizations (id, name, description) VALUES 
('00000000-0000-0000-0000-000000000001', 'Pempek Palembang', 'Sample organization for testing');

-- Insert sample outlet
INSERT INTO outlets (id, organization_id, name, address) VALUES 
('00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 'Main Outlet', 'Jl. Sudirman No. 123, Palembang');

-- Insert sample categories
INSERT INTO categories (id, organization_id, name, sort_order) VALUES 
('00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 'Pempek', 1),
('00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000001', 'Minuman', 2),
('00000000-0000-0000-0000-000000000003', '00000000-0000-0000-0000-000000000001', 'Lainnya', 3);

-- Insert sample products
INSERT INTO products (id, organization_id, category_id, name, description, price, cost, sort_order) VALUES 
('00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 'Pempek Kapal Selam', 'Pempek dengan telur di dalam', 25000, 15000, 1),
('00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 'Pempek Lenjer', 'Pempek bentuk panjang', 20000, 12000, 2),
('00000000-0000-0000-0000-000000000003', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 'Pempek Adaan', 'Pempek bulat', 15000, 9000, 3),
('00000000-0000-0000-0000-000000000004', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002', 'Es Teh Manis', 'Teh manis dingin', 5000, 2000, 1),
('00000000-0000-0000-0000-000000000005', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002', 'Es Jeruk', 'Jeruk peras dingin', 8000, 3000, 2);

-- Insert sample ingredients
INSERT INTO ingredients (id, organization_id, name, unit, current_stock, min_stock, cost_per_unit) VALUES 
('00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 'Tepung Tapioka', 'kg', 50, 10, 15000),
('00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000001', 'Ikan Tenggiri', 'kg', 20, 5, 80000),
('00000000-0000-0000-0000-000000000003', '00000000-0000-0000-0000-000000000001', 'Telur', 'butir', 100, 20, 2500),
('00000000-0000-0000-0000-000000000004', '00000000-0000-0000-0000-000000000001', 'Gula', 'kg', 25, 5, 12000),
('00000000-0000-0000-0000-000000000005', '00000000-0000-0000-0000-000000000001', 'Teh', 'kg', 5, 1, 100000);

-- Insert sample recipes
INSERT INTO recipes (id, product_id, name, instructions) VALUES 
('00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 'Resep Pempek Kapal Selam', 'Campur tepung dan ikan, bentuk, isi telur, goreng'),
('00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000002', 'Resep Pempek Lenjer', 'Campur tepung dan ikan, bentuk panjang, goreng'),
('00000000-0000-0000-0000-000000000003', '00000000-0000-0000-0000-000000000003', 'Resep Pempek Adaan', 'Campur tepung dan ikan, bentuk bulat, goreng'),
('00000000-0000-0000-0000-000000000004', '00000000-0000-0000-0000-000000000004', 'Resep Es Teh Manis', 'Seduh teh, tambah gula, dinginkan'),
('00000000-0000-0000-0000-000000000005', '00000000-0000-0000-0000-000000000005', 'Resep Es Jeruk', 'Peras jeruk, tambah gula, dinginkan');

-- Insert sample recipe items
INSERT INTO recipe_items (id, recipe_id, ingredient_id, quantity) VALUES 
('00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 0.5),
('00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002', 0.3),
('00000000-0000-0000-0000-000000000003', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000003', 1),
('00000000-0000-0000-0000-000000000004', '00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000001', 0.4),
('00000000-0000-0000-0000-000000000005', '00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000002', 0.25),
('00000000-0000-0000-0000-000000000006', '00000000-0000-0000-0000-000000000003', '00000000-0000-0000-0000-000000000001', 0.3),
('00000000-0000-0000-0000-000000000007', '00000000-0000-0000-0000-000000000003', '00000000-0000-0000-0000-000000000002', 0.2),
('00000000-0000-0000-0000-000000000008', '00000000-0000-0000-0000-000000000004', '00000000-0000-0000-0000-000000000005', 0.02),
('00000000-0000-0000-0000-000000000009', '00000000-0000-0000-0000-000000000004', '00000000-0000-0000-0000-000000000004', 0.03),
('00000000-0000-0000-0000-000000000010', '00000000-0000-0000-0000-000000000005', '00000000-0000-0000-0000-000000000004', 0.02);

-- Insert sample dining tables
INSERT INTO dining_tables (id, organization_id, outlet_id, number, capacity) VALUES 
('00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 'MEJA-01', 4),
('00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 'MEJA-02', 4),
('00000000-0000-0000-0000-000000000003', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 'MEJA-03', 6),
('00000000-0000-0000-0000-000000000004', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 'MEJA-04', 2),
('00000000-0000-0000-0000-000000000005', '00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000001', 'MEJA-05', 8);